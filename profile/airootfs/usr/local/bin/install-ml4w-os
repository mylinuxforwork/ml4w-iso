#!/bin/bash

# --- 0. Safety Cleanup ---
umount -R /mnt &>/dev/null

# --- 1. Checks ---
if [[ $EUID -ne 0 ]]; then
   gum style --foreground "#f38ba8" "ERROR: Run with sudo!"
   exit 1
fi

echo ":: Checking internet..."
if ! ping -c 1 8.8.8.8 &>/dev/null; then
   gum style --foreground "#f38ba8" "ERROR: Internet required."
   exit 1
fi

figlet -f smslant "ML4W OS Install"
echo ":: This script will install ML4W OS to your hard drive."
echo

# --- 2. Setup ---
TEST_MODE=false
[[ "$1" == "--test" ]] && TEST_MODE=true
IS_EFI=false
[[ -d "/sys/firmware/efi" ]] && IS_EFI=true

# 3. Drive Selection
TARGET_DRIVE=$(lsblk -dpno NAME,SIZE | gum choose --header "Select Drive" | awk '{print $1}')
[ -z "$TARGET_DRIVE" ] && exit 1
if [[ $TARGET_DRIVE =~ [0-9]$ ]]; then P="p"; else P=""; fi
EFI_PART="${TARGET_DRIVE}${P}1"
ROOT_PART="${TARGET_DRIVE}${P}2"

# 4. Input Validation
NEW_HOSTNAME=""
while [[ -z "$NEW_HOSTNAME" ]]; do NEW_HOSTNAME=$(gum input --placeholder "Hostname"); done
ROOT_PASS=""
while [[ -z "$ROOT_PASS" ]]; do ROOT_PASS=$(gum input --password --placeholder "Root Password"); done
NEW_USER=""
while [[ -z "$NEW_USER" ]]; do NEW_USER=$(gum input --placeholder "Username"); done
NEW_PASS=""
while [[ -z "$NEW_PASS" ]]; do NEW_PASS=$(gum input --password --placeholder "User Password"); done

# 5. Summary
clear
figlet -f smslant "Summary"
echo "  User:      $NEW_USER"
echo "  Hostname:  $NEW_HOSTNAME"
echo "  Drive:     $TARGET_DRIVE"
echo "  Partition: $ROOT_PART"
echo "  Boot Mode: $([ "$IS_EFI" = true ] && echo "UEFI" || echo "BIOS")"
echo ""
gum confirm "WARNING: This will wipe $TARGET_DRIVE. Continue?" || exit 1

set -e 

# --- EXECUTION ---
echo ":: Step 1: Partitioning..."
if [ "$TEST_MODE" = false ]; then
    sgdisk -Z $TARGET_DRIVE
    if [ "$IS_EFI" = true ]; then
        sgdisk -n 1:0:+512M -t 1:ef00 $TARGET_DRIVE
    else
        # BIOS FIX: Use relative alignment to prevent sector 34 error
        sgdisk -n 1:0:+1M -t 1:ef02 $TARGET_DRIVE
    fi
    sgdisk -n 2:0:0 -t 2:8300 $TARGET_DRIVE
    partprobe $TARGET_DRIVE
    sleep 2
fi

echo ":: Step 2: Formatting..."
if [ "$TEST_MODE" = false ]; then
    if [ "$IS_EFI" = true ]; then mkfs.vfat -F 32 "$EFI_PART"; fi
    mkfs.btrfs -L ARCH_ROOT -f "$ROOT_PART"
fi

echo ":: Step 3: Btrfs Subvolumes..."
if [ "$TEST_MODE" = false ]; then

    echo ":: Mounting root temporarily to create subvolumes..."
    mount "$ROOT_PART" /mnt
    
    echo ":: Creating subvolumes..."
    btrfs subvolume create /mnt/@
    btrfs subvolume create /mnt/@home
    btrfs subvolume create /mnt/@log
    btrfs subvolume create /mnt/@pkg
    btrfs subvolume create /mnt/@.snapshots

    echo ":: Unmounting to remount with correct options..."
    umount /mnt
    
    echo ":: Mounting root..."
    mount -o noatime,compress=zstd,subvol=@ "$ROOT_PART" /mnt

    echo ":: Creating directories..."
    mkdir -p /mnt/home
    mkdir -p /mnt/var/log
    mkdir -p /mnt/var/cache/pacman/pkg
    mkdir -p /mnt/.snapshots
    mkdir -p /mnt/boot

    echo ":: Mounting subvolumes..."
    mount -o noatime,compress=zstd,subvol=@home "$ROOT_PART" /mnt/home
    mount -o noatime,compress=zstd,subvol=@log "$ROOT_PART" /mnt/var/log
    mount -o noatime,compress=zstd,subvol=@pkg "$ROOT_PART" /mnt/var/cache/pacman/pkg
    mount -o noatime,compress=zstd,subvol=@.snapshots "$ROOT_PART" /mnt/.snapshots

    if [ "$IS_EFI" = true ]; then 
        echo ":: Mounting EFI..."
        mount "$EFI_PART" /mnt/boot; 
    fi
fi

echo ":: Step 4: Preparing Skeleton..."
if [ -f /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.bak ]; then
    mv /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.bak /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.conf
else
    echo "ERROR: /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.bak doesn't exist."
fi

echo ":: Step 5: Cloning System..."
if [ "$TEST_MODE" = false ]; then
    rsync -aAXhW --numeric-ids --info=progress2 \
        --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} \
        --exclude="/var/cache/pacman/pkg/*" \
        --exclude="/var/log/*" \
        --exclude="/etc/pacman.d/gnupg/*" \
        / /mnt/
fi

echo ":: Step 6: Configuration (Chroot)..."
if [ "$TEST_MODE" = false ]; then
    genfstab -U /mnt >> /mnt/etc/fstab
    cp --remove-destination /etc/resolv.conf /mnt/etc/resolv.conf

    echo ":: Waiting for UUID..."
    partprobe $TARGET_DRIVE
    udevadm settle
    sleep 2
    ROOT_UUID=$(lsblk -no UUID $ROOT_PART)
    if [ -z "$ROOT_UUID" ]; then sleep 3; ROOT_UUID=$(blkid -s UUID -o value $ROOT_PART); fi
    if [ -z "$ROOT_UUID" ]; then echo "ERROR: No UUID found."; exit 1; fi

    arch-chroot /mnt /bin/bash <<EOF
    set -e
    pacman-key --init
    pacman-key --populate archlinux
    
    echo ":: Cleaning boot config..."
    pacman -Rns --noconfirm archiso || true
    rm -rf /etc/mkinitcpio.conf.d
    rm -f /etc/mkinitcpio.d/*.preset
    rm -f /boot/vmlinuz* /boot/initramfs*
    
    echo "MODULES=(btrfs)" > /etc/mkinitcpio.conf
    echo "BINARIES=()" >> /etc/mkinitcpio.conf
    echo "FILES=()" >> /etc/mkinitcpio.conf
    echo "HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block filesystems fsck)" >> /etc/mkinitcpio.conf
    
    echo ":: Removing Live User and Autologin configs..."
    userdel -f -r liveuser || true
    rm -rf /etc/sddm.conf.d/*
    if [ -f /etc/sddm.conf ]; then
        sed -i '/Autologin/d' /etc/sddm.conf
        sed -i '/User=liveuser/d' /etc/sddm.conf
    fi

    rm -f /etc/sudoers.d/g_wheel
    rm -f /etc/sudoers.d/01_archiso
    
    echo ":: Installing Linux Packages..."
    pacman -Sy --noconfirm linux linux-firmware btrfs-progs grub $([ "$IS_EFI" = true ] && echo "efibootmgr")
    mkinitcpio -P

    echo ":: Installing Grub..."
    if [ "$IS_EFI" = true ]; then
        grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --recheck
    else
        grub-install --target=i386-pc "$TARGET_DRIVE" --recheck
    fi
    
    sed -i 's/#GRUB_DISABLE_OS_PROBER=false/GRUB_DISABLE_OS_PROBER=false/' /etc/default/grub
    sed -i "s|^GRUB_CMDLINE_LINUX_DEFAULT=.*|GRUB_CMDLINE_LINUX_DEFAULT=\"root=UUID=$ROOT_UUID rootflags=subvol=@ rw\"|" /etc/default/grub
    grub-mkconfig -o /boot/grub/grub.cfg
    
    echo "Setting Hostname..."
    echo "$NEW_HOSTNAME" > /etc/hostname

    echo "Setting password for root..."
    echo "root:$ROOT_PASS" | chpasswd

    echo "Adding new user '$NEW_USER'..."
    useradd -m -G wheel -s /bin/bash "$NEW_USER"
    echo "$NEW_USER:$NEW_PASS" | chpasswd
    sed -i 's/# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers

    echo "Enabling NetworkManager..."    
    systemctl enable NetworkManager

    echo "Enabling sddm..."    
    systemctl enable sddm
EOF
    umount -R /mnt
fi

echo ":: Step 7: Cleaning up..."
if [ -f /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.conf ]; then
    mv /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.conf /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.bak
else
    echo "ERROR: /etc/skel/.mydotfiles/com.ml4w.dotfiles/stable/.config/hypr/hypridle.conf doesn't exist."
fi

echo
figlet -f smslant "Done!"
echo ":: Installation Complete. Reboot and enjoy ML4W OS!"
echo
if gum confirm "Do you want to reboot your system now?"; then
    reboot
fi